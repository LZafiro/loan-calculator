<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Financiamento com Taxa Selic Automática</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        h1, h2 {
            color: #0066cc;
            margin-bottom: 20px;
        }
        
        .form-container, .result-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        input, button, select {
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0052a3;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-title {
            font-weight: bold;
        }
        
        .result-value {
            font-family: monospace;
            font-size: 16px;
        }
        
        .taxas-container {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
        }
        
        .taxa-input {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .taxa-input span {
            width: 80px;
        }
        
        .taxa-input input {
            flex: 1;
        }
        
        #addTaxa {
            width: auto;
            padding: 8px 12px;
            margin-top: 5px;
            background-color: #28a745;
        }
        
        #addTaxa:hover {
            background-color: #218838;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 102, 204, 0.3);
            border-radius: 50%;
            border-top-color: #0066cc;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-container {
            margin-bottom: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            background-color: #e9f5ff;
            border-left: 4px solid #0066cc;
        }
        
        .status-selic {
            font-weight: bold;
            color: #0066cc;
        }
        
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
            display: none;
        }
        
        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            margin-bottom: 0;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }
        
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .historico-table th, .historico-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .historico-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .historico-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
            border-left: 3px solid #0066cc;
        }
    </style>
</head>
<body>
    <h1>Calculadora de Financiamento com Taxa Selic Automática</h1>
    
    <div id="statusContainer" class="status-container">
        <div id="apiStatus">
            <span id="loadingIndicator" class="loading"></span>
            <span>Buscando taxa Selic atual do Banco Central do Brasil...</span>
        </div>
        <div id="selicInfo" style="display: none;">
            Taxa Selic atual: <span id="selicValue" class="status-selic">0,00%</span> ao mês
        </div>
    </div>
    
    <div id="errorMessage" class="error-message"></div>
    
    <div class="form-container">
        <div class="form-group">
            <label for="valorTotal">Valor total emprestado (R$):</label>
            <input type="number" id="valorTotal" min="1" step="0.01" value="50000">
        </div>
        
        <div class="form-group">
            <label for="totalParcelas">Número total de parcelas:</label>
            <input type="number" id="totalParcelas" min="1" step="1" value="36">
        </div>
        
        <div class="form-group">
            <label for="parcelaAtual">Número da parcela atual:</label>
            <input type="number" id="parcelaAtual" min="1" step="1" value="10">
        </div>
        
        <div class="form-group">
            <label for="usarSelic">Usar taxa de juros:</label>
            <select id="usarSelic">
                <option value="selic">Taxa Selic atual</option>
                <option value="manual">Taxa manual</option>
            </select>
        </div>
        
        <div id="taxaManualContainer" class="form-group" style="display: none;">
            <label for="taxaManual">Taxa de juros mensal manual (%):</label>
            <input type="number" id="taxaManual" min="0" step="0.01" value="1.00">
        </div>
        
        <div id="modoHistoricoContainer" class="form-group">
            <label class="checkbox-container" for="historicoSelic">
                <input type="checkbox" id="historicoSelic" checked> 
                Usar histórico da Selic automaticamente
            </label>
            <p class="info-text">Quando selecionado, o sistema buscará automaticamente o histórico de taxas Selic mensais do Banco Central do Brasil.</p>
        </div>
        
        <div id="historicoManualContainer" class="form-group" style="display: none;">
            <label>Histórico de taxas mensais (%):</label>
            <div id="taxasContainer" class="taxas-container"></div>
            <button id="addTaxa" type="button">Adicionar taxa</button>
        </div>
        
        <button id="calcular" type="button">Calcular parcela atual</button>
    </div>
    
    <div id="resultado" class="result-container" style="display: none;">
        <h2>Resultado do cálculo</h2>
        
        <div class="result-row">
            <span class="result-title">Valor da parcela atual:</span>
            <span id="valorParcela" class="result-value">R$ 0,00</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Componente de juros:</span>
            <span id="valorJuros" class="result-value">R$ 0,00</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Componente de amortização:</span>
            <span id="valorAmortizacao" class="result-value">R$ 0,00</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Saldo devedor antes do pagamento:</span>
            <span id="saldoAntes" class="result-value">R$ 0,00</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Saldo devedor após o pagamento:</span>
            <span id="saldoDepois" class="result-value">R$ 0,00</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Parcelas restantes:</span>
            <span id="parcelasRestantes" class="result-value">0</span>
        </div>
        
        <div class="result-row">
            <span class="result-title">Taxa utilizada:</span>
            <span id="taxaUtilizada" class="result-value">0,00%</span>
        </div>
    </div>
    
    <script>
        // Variáveis globais
        let taxaSelicMensal = 0;
        let selicCarregada = false;
        let historicoTaxasSelic = [];
        
        // Elementos DOM
        const statusContainer = document.getElementById('statusContainer');
        const apiStatus = document.getElementById('apiStatus');
        const selicInfo = document.getElementById('selicInfo');
        const selicValue = document.getElementById('selicValue');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const usarSelic = document.getElementById('usarSelic');
        const taxaManualContainer = document.getElementById('taxaManualContainer');
        const taxasContainer = document.getElementById('taxasContainer');
        const btnAddTaxa = document.getElementById('addTaxa');
        const btnCalcular = document.getElementById('calcular');
        const resultadoDiv = document.getElementById('resultado');
        const historicoSelicCheckbox = document.getElementById('historicoSelic');
        const modoHistoricoContainer = document.getElementById('modoHistoricoContainer');
        
        /**
         * Função para buscar o histórico de taxas Selic mensais da API do Banco Central do Brasil
         * @param {number} numMeses - Número de meses para buscar no histórico
         * @returns {Promise<Array>} Array com taxas mensais em ordem cronológica (mais antiga primeiro)
         */
        async function buscarHistoricoTaxasSelic(numMeses) {
            try {
                // URL da API do Banco Central - Busca as taxas Selic acumuladas nos últimos N meses
                const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados/ultimos/${numMeses}?formato=json`;
                
                // Exibe mensagem de carregamento no console
                console.log(`Buscando histórico de ${numMeses} meses da Taxa Selic...`);
                
                // Faz a requisição para a API
                const response = await fetch(url);
                
                // Verifica se a resposta foi bem-sucedida
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);
                }
                
                // Converte a resposta para JSON
                const data = await response.json();
                
                // Verifica se há dados
                if (!data || !data.length) {
                    throw new Error('Nenhum dado recebido da API');
                }
                
                console.log(`Recebidos ${data.length} meses de histórico da Taxa Selic`);
                
                // Converte os valores para decimal e inverte a ordem (mais antiga primeiro)
                // A API retorna do mais recente para o mais antigo, então invertemos
                // para ter a ordem cronológica correta (do mais antigo ao mais recente)
                const historicoTaxas = data
                    .map(item => ({
                        data: item.data,
                        valor: parseFloat(item.valor) / 100 // Converte para decimal
                    }))
                    .reverse(); 
                
                return historicoTaxas;
            } catch (error) {
                console.error('Erro ao buscar histórico de taxas Selic:', error);
                errorMessage.textContent = `Erro ao buscar histórico de taxas: ${error.message}. Usando taxas padrão.`;
                errorMessage.style.display = 'block';
                
                // Em caso de erro, retorna um array com taxas padrão
                const taxasPadrao = Array(numMeses).fill().map(() => ({
                    data: 'N/D',
                    valor: 0.009 // 0,90% como taxa padrão
                }));
                
                return taxasPadrao;
            }
        }
        
        /**
         * Função para buscar a taxa Selic mensal atual da API do Banco Central do Brasil
         */
        async function buscarTaxaSelicMensal() {
            try {
                // URL da API do Banco Central - Busca a taxa Selic acumulada no mês
                const url = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados/ultimos/1?formato=json';
                
                // Faz a requisição para a API
                const response = await fetch(url);
                
                // Verifica se a resposta foi bem-sucedida
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);
                }
                
                // Converte a resposta para JSON
                const data = await response.json();
                
                // Verifica se há dados
                if (!data || !data.length) {
                    throw new Error('Nenhum dado recebido da API');
                }
                
                // Extrai e converte a taxa Selic mensal para decimal
                const taxaMensal = parseFloat(data[0].valor) / 100;
                console.log(`Taxa Selic mensal: ${taxaMensal.toFixed(6)} (${data[0].data})`);
                
                // Exibe a data da taxa na interface
                const dataFormatada = data[0].data;
                
                // Atualiza a interface
                selicInfo.innerHTML = `Taxa Selic atual: <span id="selicValue" class="status-selic">${(taxaMensal * 100).toFixed(2)}%</span> ao mês <small>(referência: ${dataFormatada})</small>`;
                apiStatus.style.display = 'none';
                selicInfo.style.display = 'block';
                
                // Atualiza variáveis globais
                taxaSelicMensal = taxaMensal;
                selicCarregada = true;
                
                return taxaMensal;
            } catch (error) {
                // Em caso de erro, exibe mensagem e usa uma taxa padrão
                console.error('Erro ao buscar taxa Selic:', error);
                errorMessage.textContent = `Erro ao buscar taxa Selic: ${error.message}. Usando taxa padrão de 0,90% ao mês.`;
                errorMessage.style.display = 'block';
                apiStatus.style.display = 'none';
                selicInfo.style.display = 'block';
                selicInfo.innerHTML = `Taxa Selic atual: <span id="selicValue" class="status-selic">0,90% (padrão)</span> ao mês`;
                
                // Atualiza variáveis globais com valores padrão
                taxaSelicMensal = 0.009; // 0,90% ao mês
                selicCarregada = true;
                
                return taxaSelicMensal;
            }
        }
        
        /**
         * Calcula o valor da parcela atual em um financiamento com taxas variáveis
         * @param {number} valorTotal - Valor total emprestado inicialmente
         * @param {number} parcelaAtual - Número da parcela atual (começando em 1)
         * @param {number} totalParcelas - Número total de parcelas
         * @param {number} taxaAtual - Taxa de juros mensal atual (em decimal, ex: 0.01 para 1%)
         * @param {Array<number>} historicoTaxas - Array com histórico de taxas mensais desde o mês 1
         * @returns {Object} Informações sobre a parcela atual e saldo
         */
        function calcularParcelaAtual(valorTotal, parcelaAtual, totalParcelas, taxaAtual, historicoTaxas) {
            // Validações de entrada
            if (parcelaAtual < 1 || parcelaAtual > totalParcelas) {
                throw new Error(`Parcela atual (${parcelaAtual}) deve estar entre 1 e ${totalParcelas}`);
            }
            
            if (historicoTaxas.length < parcelaAtual - 1) {
                throw new Error(`Histórico de taxas incompleto. Esperado ${parcelaAtual - 1} taxas, recebido ${historicoTaxas.length}`);
            }
            
            // Saldo devedor inicial é o valor total emprestado
            let saldoDevedor = valorTotal;
            
            // Simula as parcelas anteriores para calcular o saldo devedor atual
            for (let i = 0; i < parcelaAtual - 1; i++) {
                const taxaMes = historicoTaxas[i];
                
                // Calcula juros do mês
                const jurosMes = saldoDevedor * taxaMes;
                
                // Calcula parcela do mês usando a taxa daquele mês e parcelas restantes
                const parcelasRestantes = totalParcelas - i;
                const valorParcelaMes = calcularParcela(saldoDevedor, parcelasRestantes, taxaMes);
                
                // Calcula amortização (parcela menos juros)
                const amortizacaoMes = valorParcelaMes - jurosMes;
                
                // Atualiza saldo devedor
                saldoDevedor -= amortizacaoMes;
            }
            
            // Calcula parcela atual com base no saldo devedor atual
            const parcelasRestantes = totalParcelas - (parcelaAtual - 1);
            const valorParcelaAtual = calcularParcela(saldoDevedor, parcelasRestantes, taxaAtual);
            
            // Calcula componentes da parcela atual
            const jurosAtual = saldoDevedor * taxaAtual;
            const amortizacaoAtual = valorParcelaAtual - jurosAtual;
            const saldoDevedorAposAtual = saldoDevedor - amortizacaoAtual;
            
            // Retorna informações detalhadas
            return {
                valorParcela: valorParcelaAtual,
                juros: jurosAtual,
                amortizacao: amortizacaoAtual,
                saldoDevedorAtual: saldoDevedor,
                saldoDevedorAposPagamento: saldoDevedorAposAtual,
                parcelaAtual: parcelaAtual,
                parcelasRestantes: parcelasRestantes,
                taxaUtilizada: taxaAtual
            };
        }
        
        /**
         * Calcula o valor de uma parcela usando a fórmula de financiamento
         * PMT = PV * [r(1+r)^n] / [(1+r)^n - 1]
         * 
         * @param {number} valorPresente - Valor presente (saldo devedor)
         * @param {number} numParcelas - Número de parcelas restantes
         * @param {number} taxaMensal - Taxa de juros mensal (em decimal)
         * @returns {number} Valor da parcela
         */
        function calcularParcela(valorPresente, numParcelas, taxaMensal) {
            // Se taxa zero, divide igualmente
            if (taxaMensal === 0) {
                return valorPresente / numParcelas;
            }
            
            // Aplica fórmula de financiamento
            const numerador = taxaMensal * Math.pow(1 + taxaMensal, numParcelas);
            const denominador = Math.pow(1 + taxaMensal, numParcelas) - 1;
            
            return valorPresente * (numerador / denominador);
        }
        
        /**
         * Adiciona campos de taxas iniciais com base no número da parcela atual
         */
        function adicionarCamposTaxasIniciais() {
            // Limpa o container
            taxasContainer.innerHTML = '';
            
            // Obtém o número da parcela atual
            const parcelaAtual = parseInt(document.getElementById('parcelaAtual').value, 10);
            
            // Adiciona campos para as parcelas anteriores
            for (let i = 1; i < parcelaAtual; i++) {
                adicionarCampoTaxa(i);
            }
        }
        
        /**
         * Adiciona um campo de taxa para um mês específico
         */
        function adicionarCampoTaxa(mes) {
            const taxaDiv = document.createElement('div');
            taxaDiv.className = 'taxa-input';
            
            const mesSpan = document.createElement('span');
            mesSpan.textContent = `Mês ${mes}:`;
            
            const taxaInput = document.createElement('input');
            taxaInput.type = 'number';
            taxaInput.min = '0';
            taxaInput.step = '0.01';
            taxaInput.value = '0.90';
            taxaInput.className = 'taxa-input-field';
            taxaInput.dataset.mes = mes;
            
            taxaDiv.appendChild(mesSpan);
            taxaDiv.appendChild(taxaInput);
            
            taxasContainer.appendChild(taxaDiv);
        }
        
        /**
         * Obtém todas as taxas do histórico a partir dos campos manuais
         */
        function obterTaxasManuais() {
            const taxas = [];
            const taxasInputs = document.querySelectorAll('.taxa-input-field');
            
            taxasInputs.forEach(input => {
                const valor = parseFloat(input.value) / 100; // Converte percentual para decimal
                taxas.push(valor);
            });
            
            return taxas;
        }
        
        /**
         * Exibe o histórico de taxas na interface
         * @param {Array} taxasUtilizadas - Array com as taxas utilizadas no cálculo
         * @param {boolean} usouHistoricoAutomatico - Indica se usou histórico automático
         */
        function exibirHistoricoTaxas(taxasUtilizadas, usouHistoricoAutomatico) {
            // Remove qualquer histórico anterior
            const historicoAnterior = document.getElementById('historico-taxas');
            if (historicoAnterior) {
                historicoAnterior.remove();
            }
            
            // Cria uma tabela para exibir o histórico
            const historicoDiv = document.createElement('div');
            historicoDiv.className = 'historico-info';
            historicoDiv.id = 'historico-taxas';
            
            const titulo = usouHistoricoAutomatico 
                ? '<h3>Histórico de Taxas Selic Utilizadas (Automático)</h3>'
                : '<h3>Histórico de Taxas Utilizadas (Manual)</h3>';
                
            historicoDiv.innerHTML = titulo;
            
            const table = document.createElement('table');
            table.className = 'historico-table';
            
            // Cabeçalho da tabela
            const thead = document.createElement('thead');
            if (usouHistoricoAutomatico && historicoTaxasSelic.length > 0) {
                thead.innerHTML = `
                    <tr>
                        <th>Mês/Parcela</th>
                        <th>Data de Referência</th>
                        <th>Taxa Mensal</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>Mês/Parcela</th>
                        <th>Taxa Mensal</th>
                    </tr>
                `;
            }
            table.appendChild(thead);
            
            // Corpo da tabela
            const tbody = document.createElement('tbody');
            
            // Obtém as taxas necessárias para a parcela atual
            const parcelaAtual = parseInt(document.getElementById('parcelaAtual').value, 10);
            
            // Adiciona as taxas históricas na tabela
            if (usouHistoricoAutomatico && historicoTaxasSelic.length > 0) {
                for (let i = 0; i < taxasUtilizadas.length; i++) {
                    const tr = document.createElement('tr');
                    
                    if (i < historicoTaxasSelic.length) {
                        // Taxa do histórico automático
                        tr.innerHTML = `
                            <td>Mês ${i + 1}</td>
                            <td>${historicoTaxasSelic[i].data}</td>
                            <td>${formatarPercentual(taxasUtilizadas[i])}</td>
                        `;
                    } else {
                        // Taxa complementar (caso faltem taxas no histórico)
                        tr.innerHTML = `
                            <td>Mês ${i + 1}</td>
                            <td>N/D (taxa atual utilizada)</td>
                            <td>${formatarPercentual(taxasUtilizadas[i])}</td>
                        `;
                    }
                    
                    tbody.appendChild(tr);
                }
            } else {
                // Taxas manuais
                for (let i = 0; i < taxasUtilizadas.length; i++) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>Mês ${i + 1}</td>
                        <td>${formatarPercentual(taxasUtilizadas[i])}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
            
            // Adiciona a taxa atual
            const trAtual = document.createElement('tr');
            trAtual.style.fontWeight = 'bold';
            trAtual.style.backgroundColor = '#e9f5ff';
            
            if (usouHistoricoAutomatico && historicoTaxasSelic.length > 0) {
                const usarSelicValue = document.getElementById('usarSelic').value;
                const taxaAtual = usarSelicValue === 'selic' ? taxaSelicMensal : parseFloat(document.getElementById('taxaManual').value) / 100;
                
                trAtual.innerHTML = `
                    <td>Parcela Atual (${parcelaAtual})</td>
                    <td>ATUAL</td>
                    <td>${formatarPercentual(taxaAtual)}</td>
                `;
            } else {
                const usarSelicValue = document.getElementById('usarSelic').value;
                const taxaAtual = usarSelicValue === 'selic' ? taxaSelicMensal : parseFloat(document.getElementById('taxaManual').value) / 100;
                
                trAtual.innerHTML = `
                    <td>Parcela Atual (${parcelaAtual})</td>
                    <td>${formatarPercentual(taxaAtual)}</td>
                `;
            }
            
            tbody.appendChild(trAtual);
            table.appendChild(tbody);
            historicoDiv.appendChild(table);
            
            // Adiciona a tabela abaixo do resultado
            resultadoDiv.appendChild(historicoDiv);
        }
        
        /**
         * Formata valor monetário
         */
        function formatarMoeda(valor) {
            return `R$ ${valor.toFixed(2)}`.replace('.', ',');
        }
        
        /**
         * Formata percentual
         */
        function formatarPercentual(valor) {
            return `${(valor * 100).toFixed(2)}%`.replace('.', ',');
        }
        
        /**
         * Calcula e exibe o resultado
         */
        async function calcular() {
            try {
                // Limpa mensagens de erro anteriores
                errorMessage.style.display = 'none';
                
                // Obtém valores do formulário
                const valorTotal = parseFloat(document.getElementById('valorTotal').value);
                const totalParcelas = parseInt(document.getElementById('totalParcelas').value, 10);
                const parcelaAtual = parseInt(document.getElementById('parcelaAtual').value, 10);
                const usarSelicValue = document.getElementById('usarSelic').value;
                const usarHistoricoSelic = document.getElementById('historicoSelic').checked;
                
                // Determina a taxa atual a ser utilizada
                let taxaAtual;
                if (usarSelicValue === 'selic') {
                    taxaAtual = taxaSelicMensal;
                } else {
                    taxaAtual = parseFloat(document.getElementById('taxaManual').value) / 100;
                }
                
                // Obter histórico de taxas
                let historicoTaxas;
                
                if (usarHistoricoSelic) {
                    // Número de meses anteriores necessários para o cálculo
                    const mesesNecessarios = parcelaAtual - 1;
                    
                    // Se não temos histórico ou precisamos de mais taxas, busca novamente
                    if (historicoTaxasSelic.length === 0 || historicoTaxasSelic.length < mesesNecessarios) {
                        try {
                            // Exibe mensagem de carregamento
                            apiStatus.style.display = 'block';
                            loadingIndicator.style.display = 'inline-block';
                            apiStatus.querySelector('span:not(.loading)').textContent = `Buscando histórico de ${mesesNecessarios} meses anteriores da Taxa Selic...`;
                            
                            // Busca exatamente o número de meses necessários (mais uma margem de segurança)
                            const mesesABuscar = mesesNecessarios + 2; // Margem de segurança
                            historicoTaxasSelic = await buscarHistoricoTaxasSelic(mesesABuscar);
                            
                            // Esconde mensagem de carregamento
                            apiStatus.style.display = 'none';
                        } catch (err) {
                            console.error('Erro ao buscar histórico:', err);
                            apiStatus.style.display = 'none';
                            errorMessage.textContent = `Erro ao buscar histórico de taxas: ${err.message}. Usando taxas padrão.`;
                            errorMessage.style.display = 'block';
                        }
                    }
                    
                    // Obtém as taxas dos meses anteriores
                    if (historicoTaxasSelic.length >= mesesNecessarios) {
                        // Usa exatamente o número de meses anteriores necessários
                        historicoTaxas = historicoTaxasSelic
                            .slice(0, mesesNecessarios) // Pega apenas os meses necessários
                            .map(item => item.valor); // Extrai apenas os valores das taxas
                    } else {
                        // Se não houver taxas suficientes, exibe aviso e usa as taxas disponíveis
                        console.warn(`Histórico insuficiente: necessários ${mesesNecessarios} meses, mas só temos ${historicoTaxasSelic.length}`);
                        errorMessage.textContent = `Aviso: Histórico de taxas insuficiente. Usando taxas disponíveis e completando com a taxa atual.`;
                        errorMessage.style.display = 'block';
                        
                        // Pega as taxas disponíveis e completa com a taxa atual
                        const taxasDisponiveis = historicoTaxasSelic.map(item => item.valor);
                        const taxasComplementares = Array(mesesNecessarios - taxasDisponiveis.length).fill(taxaSelicMensal);
                        
                        historicoTaxas = [...taxasDisponiveis, ...taxasComplementares];
                    }
                } else {
                    // Usa as taxas informadas manualmente
                    historicoTaxas = obterTaxasManuais();
                }
                
                // Calcula parcela atual
                const resultado = calcularParcelaAtual(
                    valorTotal,
                    parcelaAtual,
                    totalParcelas,
                    taxaAtual,
                    historicoTaxas
                );
                
                // Exibe resultados principais
                document.getElementById('valorParcela').textContent = formatarMoeda(resultado.valorParcela);
                document.getElementById('valorJuros').textContent = formatarMoeda(resultado.juros);
                document.getElementById('valorAmortizacao').textContent = formatarMoeda(resultado.amortizacao);
                document.getElementById('saldoAntes').textContent = formatarMoeda(resultado.saldoDevedorAtual);
                document.getElementById('saldoDepois').textContent = formatarMoeda(resultado.saldoDevedorAposPagamento);
                document.getElementById('parcelasRestantes').textContent = resultado.parcelasRestantes;
                document.getElementById('taxaUtilizada').textContent = formatarPercentual(resultado.taxaUtilizada);
                
                // Mostra div de resultado
                resultadoDiv.style.display = 'block';
                
                // Exibe o histórico de taxas utilizadas
                exibirHistoricoTaxas(historicoTaxas, usarHistoricoSelic);
                
                // Rola até o resultado
                resultadoDiv.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                // Exibe erro
                console.error('Erro no cálculo:', error);
                errorMessage.textContent = `Erro no cálculo: ${error.message}`;
                errorMessage.style.display = 'block';
                resultadoDiv.style.display = 'none';
            }
        }
        
        /**
         * Alternar entre taxa Selic e taxa manual
         */
        function alternarTaxaManual() {
            const usarSelicValue = usarSelic.value;
            taxaManualContainer.style.display = usarSelicValue === 'manual' ? 'block' : 'none';
        }
        
        /**
         * Alternar entre histórico automático e manual
         */
        function alternarHistoricoAutomatico() {
            const usarHistoricoSelic = document.getElementById('historicoSelic').checked;
            const historicoManualContainer = document.getElementById('historicoManualContainer');
            
            historicoManualContainer.style.display = usarHistoricoSelic ? 'none' : 'block';
        }
        
        // Event listeners
        usarSelic.addEventListener('change', alternarTaxaManual);
        document.getElementById('historicoSelic').addEventListener('change', alternarHistoricoAutomatico);
        document.getElementById('parcelaAtual').addEventListener('change', adicionarCamposTaxasIniciais);
        btnAddTaxa.addEventListener('click', () => {
            const numTaxas = document.querySelectorAll('.taxa-input-field').length;
            adicionarCampoTaxa(numTaxas + 1);
        });
        btnCalcular.addEventListener('click', calcular);
        
        // Inicialização
        window.addEventListener('DOMContentLoaded', async () => {
            // Busca taxa Selic atual
            await buscarTaxaSelicMensal();
            
            // Adiciona campos de taxas iniciais
            adicionarCamposTaxasIniciais();
            
            // Inicia com a configuração correta de histórico
            alternarHistoricoAutomatico();
            
            // Não busca histórico inicial - apenas quando necessário
            // Isso economiza banda e acelera o carregamento inicial
        });
    </script>
</body>
</html>
